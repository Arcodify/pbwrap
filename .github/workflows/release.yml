name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from tag
        id: vars
        run: |
          TAG="${GITHUB_REF##*/}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install packaging deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev build-essential rsync
          sudo gem install --no-document fpm

      - name: Stage files
        run: |
          mkdir -p /tmp/pkgroot/opt/pbwrap
          rsync -a --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'pkg' \
            --exclude 'src' \
            --exclude '*.pkg.tar.*' \
            --exclude '*.tar.zst' \
            . /tmp/pkgroot/opt/pbwrap/

          # Create post-install script to bootstrap dirs/unit
          cat > /tmp/postinst <<'POSTINST'
          #!/usr/bin/env bash
          set -e
          [ -x /opt/pbwrap/install.sh ] && /opt/pbwrap/install.sh || true
          POSTINST
          chmod +x /tmp/postinst

      - name: Build .deb with fpm
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          fpm -s dir -t deb \
            -n pbwrap \
            -v "$VERSION" \
            -a all \
            --license GPL-3.0 \
            --description "PocketBase instance manager (systemd multi-instance wrapper)" \
            --after-install /tmp/postinst \
            /tmp/pkgroot/opt/pbwrap
          mv pbwrap_${VERSION}_all.deb /tmp/pbwrap_${VERSION}_all.deb

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: |
            /tmp/pbwrap_${{ steps.vars.outputs.version }}_all.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-arch:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install base-devel and dependencies
        run: |
          pacman -Syu --noconfirm base-devel git sudo python
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build pkg.tar.zst
        run: |
          chown -R builder:builder "${GITHUB_WORKSPACE}"
          sudo -u builder env HOME=/home/builder bash -lc "cd '${GITHUB_WORKSPACE}' && makepkg -C --syncdeps --noconfirm --clean"   
      - name: Upload Arch package
        uses: softprops/action-gh-release@v1
        with:
          files: "*.pkg.tar.zst"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-aur:
    needs: [build-deb, build-arch]
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Install base-devel + git + openssh + python
        run: |
          pacman -Syu --noconfirm base-devel git openssh python

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from tag
        id: aurvars
        run: |
          TAG="${GITHUB_REF##*/}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github"

      - name: Setup SSH key for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_SSH_KNOWN_HOSTS: ${{ secrets.AUR_SSH_KNOWN_HOSTS }}
        run: |
          install -m 700 -d ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          if [[ -n "$AUR_SSH_KNOWN_HOSTS" ]]; then
            printf "%s\n" "$AUR_SSH_KNOWN_HOSTS" | tr -d '\r' > ~/.ssh/known_hosts
          else
            ssh-keyscan -t rsa,ecdsa,ed25519 aur.archlinux.org >> ~/.ssh/known_hosts
          fi

      - name: Clone AUR repo
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/aur -o UserKnownHostsFile=~/.ssh/known_hosts -o StrictHostKeyChecking=accept-new -o IdentitiesOnly=yes"
        run: |
          git clone ssh://aur@aur.archlinux.org/pbwrap.git /tmp/aur-repo

      - name: Update PKGBUILD for tag
        env:
          VERSION: ${{ steps.aurvars.outputs.version }}
        run: |
          useradd -m builder || true
          echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
          chown -R builder:builder /tmp/aur-repo
          chown -R builder:builder "${GITHUB_WORKSPACE}"
          git config --global --add safe.directory /tmp/aur-repo
          sudo -u builder env HOME=/home/builder VER="${VERSION}" bash -lc "cd /tmp/aur-repo && cp '${GITHUB_WORKSPACE}/PKGBUILD' . && cp '${GITHUB_WORKSPACE}/pbwrap.install' . && cp '${GITHUB_WORKSPACE}/update_pkgbuild.py' . && python update_pkgbuild.py && makepkg --printsrcinfo > .SRCINFO"
      - name: Push to AUR
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/aur -o UserKnownHostsFile=~/.ssh/known_hosts -o StrictHostKeyChecking=accept-new -o IdentitiesOnly=yes"
        run: |
          cd /tmp/aur-repo
          git add PKGBUILD .SRCINFO pbwrap.install
          git commit -m "Update to v${{ steps.aurvars.outputs.version }}" || echo "No changes to commit"
          git push -u origin master
